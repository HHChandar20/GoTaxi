<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps.css" type="text/css" />
    <script type="text/javascript" src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.0/maps/maps-web.min.js"></script>
    <style>
        #taxi-page {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 90vh;
            width: 100%;
        }

        #map {
            width: 900vw;
            height: 80%;
        }

        .marker-border {
            background: yellow;
            border-radius: 50%;
            height: 40px;
            width: 40px;
        }

        .marker-icon {
            background-position: center;
            background-size: 25px 20px;
            position: absolute;
            left: 7.5px;
            top: 10px;
            height: 20px;
            width: 25px;
        }

        .marker-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mapboxgl-popup-content {
            border-radius: 10px;
        }

        #claim-button {
            background-color: red;
        }

    </style>
</head>

<body>
    <div id="taxi-page">
        <div id="map"></div>
    </div>
    <script type="text/javascript">

        let driverMarkers = [];
        let clientMarkers = [];

        function addDriverMarker(map, driver) {
            console.log("Driver: ", driver);
            const driverPosition = [driver.longitude, driver.latitude];

            let markerDiv = document.createElement('div');
            markerDiv.innerHTML =
                `
                        <p class="driverName">${driver.fullName}</p>
                        <p class="plateNumber">${driver.plateNumber}</p>
                    `;


            let markerPopup = new tt.Popup({
                closeButton: false,
                offset: 25,
                anchor: 'bottom'
            }).setDOMContent(markerDiv);

            let markerBorder = document.createElement('div');
            markerBorder.className = 'marker-border';
            markerBorder.style.background = 'green';

            let markerIcon = document.createElement('div');
            markerIcon.className = 'marker-icon';
            markerIcon.style.backgroundImage = 'url(/images/taxi-icon.png)';
            markerBorder.appendChild(markerIcon);

            const newMarker = new tt.Marker({
                element: markerBorder
            }).setLngLat(driverPosition).setPopup(markerPopup);

            newMarker.addTo(map);
            newMarker.driverPlateNumber = driver.plateNumber; // Store driver plate number in the marker

            driverMarkers.push(newMarker);
        }

        function addClientMarker(map, client) {
            const clientPosition = [client.longitude, client.latitude];

            let markerDiv = document.createElement('div');
            markerDiv.innerHTML =
                `<h6 class="destination">${client.destination}</h3>
                        <p class="name>${client.fullName}</p>
                        <p class="email>${client.email}</p>
                        <p class="phone">${client.phoneNumber}</h6>
                        <p class="reports">Reports: ${client.reports}</p>
                        <button id="claim-button" onclick="claimClient('${client.phoneNumber}')">Claim</button>`;
            markerDiv.className = 'marker-info';

            let markerPopup = new tt.Popup({
                closeButton: false,
                offset: 25,
                anchor: 'bottom'
            }).setDOMContent(markerDiv);
            markerPopup.className = 'marker-popup';

            let markerBorder = document.createElement('div');
            markerBorder.className = 'marker-border';
            markerBorder.style.background = 'red';

            let markerIcon = document.createElement('div');
            markerIcon.className = 'marker-icon';
            markerIcon.style.backgroundImage = 'url(/images/client-icon.png)';
            markerBorder.appendChild(markerIcon);

            const newMarker = new tt.Marker({
                element: markerBorder
            }).setLngLat(clientPosition).setPopup(markerPopup);

            newMarker.addTo(map);
            newMarker.clientPhoneNumber = client.phoneNumber; // Store client phone number in the marker

            clientMarkers.push(newMarker);
        }

        function updateDriverMarker(marker, driver) {
            const driverPosition = [driver.longitude, driver.latitude];

            if (marker && marker.getElement() && marker.getPopup()) {
                marker.setLngLat(driverPosition);

                const markerDiv = marker.getPopup().getElement();

                if (markerDiv) {
                    const name = markerDiv.querySelector('p.driverName');
                    const plateNumber = markerDiv.querySelector('p.plateNumber');

                    if (name) name.innerText = driver.fullName;
                    if (plateNumber) plateNumber.innerText = driver.plateNumber;
                }
            } else {
                console.error('Invalid marker or missing elements:', marker);
            }
        }

        function updateClientMarker(marker, client) {
            const clientPosition = [client.longitude, client.latitude];

            // Check if the marker is defined and has an element and popup
            if (marker && marker.getElement() && marker.getPopup()) {
                marker.setLngLat(clientPosition);

                const markerDiv = marker.getPopup().getElement();
                // Check if the required elements inside the popup exist
                if (markerDiv) {
                    const destination = markerDiv.querySelector('h3');
                    const name = markerDiv.querySelector('p.name');
                    const email = markerDiv.querySelector('p.email');
                    const phoneNumber = markerDiv.querySelector('p.phone');
                    const reports = markerDiv.querySelector('p.reports');
                    const button = markerDiv.querySelector('button');

                    // Update the elements if they exist
                    if (destination) destination.innerText = client.destination;
                    if (name) name.innerText = client.fullName;
                    if (email) email.innerText = client.email;
                    if (phoneNumber) phoneNumber.innerText = client.phoneNumber;
                    if (reports) reports.innerText = `Reports: ${client.reports}`;
                    if (button) button.onclick = function () { claimClient(client.phoneNumber); };

                }
            } else {
                console.error('Invalid marker or missing elements:', marker);
            }
        }

        function updateDriverMarkers(map, newDrivers) {
            const existingDriverPlateNumbers = driverMarkers.map(marker => marker.driverPlateNumber);
            const newDriverPlateNumbers = newDrivers.map(driver => driver.plateNumber);

            // Remove markers for drivers that are not in the new list
            const driversToRemove = driverMarkers.filter(marker => !newDriverPlateNumbers.includes(marker.driverPlateNumber));
            driversToRemove.forEach(marker => {
                marker.remove();
                driverMarkers.splice(driverMarkers.indexOf(marker));
            });

            // Update or add markers for the new drivers
            newDrivers.forEach(driver => {
                const index = existingDriverPlateNumbers.indexOf(driver.plateNumber);
                if (index !== -1) {
                    // Update existing marker
                    updateDriverMarker(driverMarkers[index], driver);
                } else {
                    // Add new marker
                    addDriverMarker(map, driver);
                }
            });
        }

        function updateClientMarkers(map, newClients) {
            const existingClientPhoneNumbers = clientMarkers.map(marker => marker.clientPhoneNumber);
            const newClientPhoneNumbers = newClients.map(client => client.phoneNumber);

            // Remove markers for clients that are not in the new list
            const clientsToRemove = clientMarkers.filter(marker => !newClientPhoneNumbers.includes(marker.clientPhoneNumber));
            clientsToRemove.forEach(marker => {
                marker.remove();
                clientMarkers.splice(clientMarkers.indexOf(marker));

            });

            // Update or add markers for the new clients
            newClients.forEach(client => {
                const index = existingClientPhoneNumbers.indexOf(client.phoneNumber);
                if (index !== -1) {
                    // Update existing marker
                    updateClientMarker(clientMarkers[index], client);
                } else {
                    // Add new marker
                    addClientMarker(map, client);
                }
            });
        }

        function getNearestDrivers(map, currentPosition) {
            fetch(`/Taxi/GetNearestDrivers?currentDriverLongitude=${currentPosition[0]}&currentDriverLatitude=${currentPosition[1]}`)
                .then(response => response.json())
                .then(nearestDrivers => {
                    console.log(nearestDrivers);
                    if (Array.isArray(nearestDrivers)) {
                        updateDriverMarkers(map, nearestDrivers);
                    } else {
                        console.error('Invalid response format:', nearestDrivers);
                    }
                })
                .catch(error => {
                    console.error('Error fetching nearest drivers:', error);
                });
        }

        function getNearestClients(map, currentPosition) {
            fetch(`/Taxi/GetNearestClients?currentClientLongitude=${currentPosition[0]}&currentClientLatitude=${currentPosition[1]}`)
                .then(response => response.json())
                .then(nearestClients => {
                    console.log(nearestClients);
                    if (Array.isArray(nearestClients)) {
                        updateClientMarkers(map, nearestClients);
                    }
                    else {
                        console.error('Invalid response format:', nearestClients);
                    }
                })
                .catch(error => {
                    console.error('Error fetching nearest clients:', error);
                });
        }

        function clearMarkers(phoneNumber) {
            driverMarkers.forEach(marker => {
                marker.remove();
            });

            clientMarkers.forEach(marker => {
                if (marker.clientPhoneNumber != phoneNumber)
                    marker.remove();
            });
        }

        function claimClient(phoneNumber) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/Taxi/ClaimClient', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log('Location update successful:', xhr.responseText);
                    } else {
                        console.error('Error updating location. Status code:', xhr.status);
                    }
                }
            };

            const jsonData = JSON.stringify(phoneNumber);
            xhr.send(jsonData);

            clearMarkers(phoneNumber);
            isActive = true;
        }

        function sendLocationToServer(longitude, latitude) {
            const locationData = {
                longitude: longitude,
                latitude: latitude
            };

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/Taxi/UpdateLocation', true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log('Location update successful:', xhr.responseText);
                    } else {
                        console.error('Error updating location. Status code:', xhr.status);
                    }
                }
            };

            const jsonData = JSON.stringify(locationData);
            xhr.send(jsonData);
        }

        function initMap() {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const userPosition = [position.coords.longitude, position.coords.latitude];
                    sendLocationToServer(userPosition[0], userPosition[1]);

                    const map = tt.map({
                        key: "MVjOYcUAh8yzcRi8zYnynWAhvqtASz8G",
                        container: 'map',
                        center: userPosition,
                        zoom: 13
                    });
                    let div = document.createElement('div');
                    div.innerHTML = '<p>You</p>';

                    let popup = new tt.Popup({
                        closeButton: false,
                        offset: 25,
                        anchor: 'bottom'
                    }).setDOMContent(div);

                    let border = document.createElement('div');
                    border.className = 'marker-border';

                    let icon = document.createElement('div');
                    icon.className = 'marker-icon';
                    icon.style.backgroundImage = 'url(/images/taxi-icon.png)';
                    border.appendChild(icon);

                    let marker = new tt.Marker({
                        element: border
                    }).setLngLat(userPosition).setPopup(popup);

                    marker.addTo(map);

                    getNearestDrivers(map, userPosition);
                    getNearestClients(map, userPosition);

                    setInterval(function () {
                        const currentPosition = [userPosition[0] += 0.0001, userPosition[1]];

                        navigator.geolocation.getCurrentPosition(
                            newPosition => {
                                const newDriverPosition = [userPosition[0] += 0.0001, userPosition[1]];

                                marker.setLngLat(currentPosition);
                                sendLocationToServer(currentPosition[0], currentPosition[1]);
                            },
                            error => {
                                console.error('Error getting user location:', error);
                            },
                            {
                                enableHighAccuracy: true
                            }
                        );

                        getNearestDrivers(map, userPosition);
                        getNearestClients(map, userPosition);

                    }, 6000); // Repeat every 6 seconds
                },
                error => {
                    console.error('Error getting user location:', error);
                },
                {
                    enableHighAccuracy: true
                }
            );
        }

        window.onload = initMap;
    </script>
</body>

</html>